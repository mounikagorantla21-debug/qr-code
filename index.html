<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student QR Scanner – Attendance View</title>

<!-- jsQR Library -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f5f5f5;
    }

    h2 {
        text-align: center;
    }

    #camera {
        width: 320px;
        height: 240px;
        border: 2px solid black;
        display: block;
        margin: 20px auto;
    }

    #resultBox {
        width: 350px;
        margin: auto;
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        display: none;
    }

    .label {
        font-weight: bold;
    }
</style>
</head>
<body>

<h2>Scan Student QR Code</h2>

<video id="camera" autoplay></video>
<canvas id="canvas" hidden></canvas>

<p style="text-align:center;" id="scanStatus">Waiting for QR code...</p>

<div id="resultBox">
    <h3>Student Details:</h3>
    <p><span class="label">Name:</span> <span id="sName"></span></p>
    <p><span class="label">Register No:</span> <span id="sRegno"></span></p>
    <p><span class="label">Branch:</span> <span id="sBranch"></span></p>
    <p><span class="label">Login Time:</span> <span id="sTime"></span></p>
</div>

<script type="module">
/* -----------------------------------------
    Firebase Setup
------------------------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyAEWAXI-ea_s9Mt5Ex3yTumsZr2xnDCY54",
    authDomain: "qrcode-f7215.firebaseapp.com",
    projectId: "qrcode-f7215",
    databaseURL: "https://qrcode-f7215-default-rtdb.firebaseio.com",
    storageBucket: "qrcode-f7215.firebasestorage.app",
    messagingSenderId: "442167727446",
    appId: "1:442167727446:web:f4962eb6e18eaeb038b2f7",
    measurementId: "G-R6JDRDTG82"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* -----------------------------------------
    QR Scanner
------------------------------------------- */
const video = document.getElementById("camera");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const scanStatus = document.getElementById("scanStatus");

navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
        video.srcObject = stream;
        video.play();
        scanLoop();
    });

function scanLoop() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);

        if (code) {
            scanStatus.innerText = "QR detected: " + code.data;
            processQR(code.data);
        }
    }
    requestAnimationFrame(scanLoop);
}

/* -----------------------------------------
    Process QR → Extract Student Reg No
------------------------------------------- */
function processQR(qrValue) {
    // QR Format: "QR_1692988282"
    // We will extract timestamp and find the student who generated it

    scanStatus.innerText = "Matching QR with database...";

    // Search all students in Firebase
    get(ref(db, "students"))
        .then(snapshot => {
            let found = false;

            snapshot.forEach(child => {
                const student = child.val();

                if (student.lastQR === qrValue) {
                    found = true;

                    document.getElementById("sName").innerText = student.name;
                    document.getElementById("sRegno").innerText = student.regno;
                    document.getElementById("sBranch").innerText = student.branch;
                    document.getElementById("sTime").innerText = student.loginTime;

                    document.getElementById("resultBox").style.display = "block";
                }
            });

            if (!found) {
                scanStatus.innerText = "No matching student found!";
            }
        });
}
</script>

</body>
</html>
